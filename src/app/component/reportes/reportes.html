<div class="card-title card">
    <h4>
        <span class="text-primary">Overtime MP</span>
        <span class="text-secondary"> Reportes</span>
    </h4>
</div>

<div class="card table-card mt-3">
    <div class="table-header">
        <div class="filters">
            <!-- Filtro Tipo-->
            <div class="filter-item search-item">
                <div class="form-floating custom-floating">
                    <select class="form-select border-info" id="filtroTipo" [(ngModel)]="filtroTipo"
                        (change)="onFilterChange()">
                        <option value="">Seleccione</option>
                        <option *ngFor="let opt of tipos" [value]="opt">{{ opt }}</option>
                    </select>
                    <label for="filtroTipo">Tipos</label>
                </div>
            </div>
            <!-- Filtro Regional-->
            <div class="filter-item search-item">
                <div class="form-floating custom-floating">
                    <select class="form-select border-info" id="filtroRegional" [(ngModel)]="filtroRegional"
                        (change)="onFilterChange()">
                        <option value="">Todos los Regionales</option>
                        <option *ngFor="let opt of regionales" [value]="opt.nombre">{{ opt.nombre }}</option>
                    </select>
                    <label for="filtroRegional">Regional</label>
                </div>
            </div>
            <!-- Filtro Jefe-->
            <div class="filter-item search-item">
                <div class="form-floating custom-floating">
                    <select class="form-select border-info" id="filtroJefe" [(ngModel)]="filtroJefe"
                        (change)="onFilterChange()">
                        <option value="">Todos los Jefes</option>
                        <option *ngFor="let opt of jefes" [value]="opt.usuarioRed">{{ opt.nombre }}</option>
                    </select>
                    <label for="filtroJefe">Jefe</label>
                </div>
            </div>

            <!-- Filtro Fecha Inicio -->
            <div class="fecha-group">
                <div class="filter-item">
                    <div class="form-floating custom-floating">
                        <input matInput [matDatepicker]="pickerInicio" class="form-control border-info" id="fechaInicio"
                            name="fechaInicio" placeholder="dd/mm/aaaa" [(ngModel)]="fechaInicio"
                            (ngModelChange)="onFechaChange()" (click)="openPicker('inicio', pickerInicio)"
                            (focus)="openPicker('inicio', pickerInicio)" [min]="minDate" [max]="maxDate"
                            aria-label="Fecha inicio" />
                        <label for="fechaInicio">*Fecha Inicio</label>
                        <mat-datepicker-toggle matSuffix [for]="pickerInicio"
                            (click)="openPicker('inicio', pickerInicio)">
                            <mat-icon (click)="openPicker('inicio', pickerInicio)">calendar_today</mat-icon>
                        </mat-datepicker-toggle>
                        <mat-datepicker #pickerInicio [calendarHeaderComponent]="CustomDatepickerHeader"
                            [startAt]="startAt"></mat-datepicker>
                    </div>
                </div>
                <div class="filter-item">
                    <div class="form-floating custom-floating">
                        <input matInput [matDatepicker]="pickerFin" class="form-control border-info" id="fechaFin"
                            name="fechaFin" placeholder="dd/mm/aaaa" [(ngModel)]="fechaFin"
                            (ngModelChange)="onFechaChange()" (click)="openPicker('fin', pickerFin)"
                            (focus)="openPicker('fin', pickerFin)" [min]="minDate" [max]="maxDate"
                            aria-label="Fecha fin" />
                        <label for="fechaFin">*Fecha Fin</label>
                        <mat-datepicker-toggle matSuffix [for]="pickerFin" (click)="openPicker('fin', pickerFin)">
                            <mat-icon (click)="openPicker('fin', pickerFin)">calendar_today</mat-icon>
                        </mat-datepicker-toggle>
                        <mat-datepicker #pickerFin [calendarHeaderComponent]="CustomDatepickerHeader"
                            [startAt]="startAt"></mat-datepicker>
                    </div>
                </div>
            </div>
            <!-- Botón Limpiar Filtros -->
            <button type="button" class="btn btn-primary" (click)="limpiarFiltros()">Limpiar</button>
            <button type="button" class="btn btn-primary" (click)="descargarReporte()">Descargar Excel</button>
        </div>
    </div>

    <div>
        <!-- Loading -->
        <div class="loading-container" *ngIf="isLoading">
            <mat-progress-spinner mode="indeterminate"></mat-progress-spinner>
        </div>

        <!-- Tabla -->
        <table mat-table [dataSource]="dataSource" class="table mat-elevation-z0" *ngIf="!isLoading">
            <!-- Columnas dinámicas -->
            <ng-container *ngFor="let col of columnDefs" [matColumnDef]="col.def">
                <th mat-header-cell *matHeaderCellDef>{{ col.header }}</th>
                <td mat-cell *matCellDef="let element">

                    <!-- Badge para estados -->
                    <span *ngIf="col.badge" class="badge" [ngClass]="{
                        'badge-warning': element[col.def] === 'PENDIENTE',
                        'badge-success': element[col.def] === 'APROBADO',
                        'badge-danger': element[col.def] === 'RECHAZADO'
                    }">
                        {{ element[col.def] }}
                    </span>

                    <!-- Fechas formateadas -->
                    <span *ngIf="col.pipe">{{ element[col.def] | date: col.pipe }}</span>

                    <!-- Texto normal -->
                    <span *ngIf="!col.badge && !col.pipe">{{ element[col.def] || '-' }}</span>
                </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
        </table>

        <!-- Paginador -->
        <div class="table-footer">
            <mat-paginator [length]="resultsLength" [pageSizeOptions]="[10, 30, 50]" aria-label="Paginador"></mat-paginator>
        </div>
    </div>
</div>

<!-- Referencia para Angular Language Service (no se renderiza) -->
<custom-datepicker-header *ngIf="false"></custom-datepicker-header>